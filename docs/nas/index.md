# NAS

>这里记录我折腾NAS的一些东西、踩过的坑。

> 阅读指南：你需要有最基本的网络、电脑知识，最起码知道NAS大概是做什么的。
>
> 本文不会事无巨细，只做总结与大方向上的分析，隐去的那些细节在网上一搜一大堆，当你操作时卡住了，再去搜索关键词也不迟。

我搭的NAS基本是all in one，如侧边索引所见，除了软路由没做，其他的都差不多了。

## 网络环境准备

在一切开始之前，要确保你的网络环境支持访问NAS。

在选择硬件、组装、购买机器之前，先使用一些简单的方法验证的你网络足以使用NAS，别买了机器才发现组了也用不了，那就白买了。

完成这一章的一系列工作，你将：能够安全、便捷地，通过域名访问每一项NAS服务。

### 内网访问

如果你只是在局域网内用，那你几乎什么都不需要做，直接用ipconfig等指令查出局域网IP，拿IP访问即可。

### 外网访问

从外网访问，要做的事情就多了，首先要确保你能有一个公网IP，能在你机器所处的运营商的局域网——例如小区以外，触达你的NAS。

#### 公网IPv6

IPv4基本不可能了，2024年的今天，几乎以个人的力量不可能拿到任何静态IP，联通移动自己也没多少，电信有也不给，我试过很多话术，人家就是不给，人家等着卖企业专线呢。如果你已经能拿到或者你家的网本身就是IPv4，那恭喜你，你可以直接跳过这一步了。

但IPv6就不一样了，这玩意给地球每一粒沙子发，都发不完，运营商没有理由限制，普通人可以轻易获得。

这东西唯一的局限就是，访问者的机器支持IPv6，不过已经24年了，这几年的新设备几乎没有不支持的，但在某些公共场所的网络，他们所提供接入网络的设备或许较老、还不支持。

- **调制解调器拨号改桥接**

  你家的光猫有两种工作模式，一种是路由模式，即现在的猫都集成了路由器的功能，并且默认以这种模式工作，把路由器的活也干了，主要目的是方便运营商控制网络接入，让用户尽可能少的参与网络配置，省的出问题麻烦。【当然，也方便运营商埋点，做数据检测，有没有监控你，那就不得而知了......第二种是桥接模式，这种模式下，调制解调器只完成他的本质工作——光电信号的转换。由路由器来进行拨号、路由/为局域网内设备分配IP。

  这里有一个细节我依旧太明白：按理说光猫承担路由功能，与让路由器自己做相比，这只是改变了我家中局域网接入外部的位置，但本质上他们完成的工作都是一样的。为什么让路由器来拨号，就能把运营商分配给他的IPv6再分配给局域网内的其他设备，而光猫拨号，公网IPv6的分配就到此为止了，光猫就不能也分配吗？我在网上搜索了很多，没得到答案，我推测可能是运营商处于安全或者什么因素的考虑，光猫一开始就被有意设置成这样——以路由模式工作时，只会对内部设备分配静态的内部IPv6地址，不分配外网地址。

  总之就是要将光猫改桥接，让路由器来拨号，这样做还有个好处就是，光猫的硬件性能普遍不怎么样，让他充当路由，性能肯定不如你自己的路由器，能更好的发挥宽带性能。

  需要注意如下几个问题：

  - 如何登陆网关/光猫管理页面？

    按照网关IP进去之后，提示管理页面需要登陆，网上的那些默认账号密码早就过时了，现在的账密都是动态生成的，通过他们运营商的终端输入猫的mac地址，动态生成的。这个东西你直接问给你装宽带的人要，或者打客服，问官方要。他们不给也没关系，一堆运营商的员工那这东西搞副业，去咸鱼搜，关键词为省名+运营商+管理员账号，把mac地址发给他们，几块钱就能给你生成一个。

  - 进光猫管理页面要怎么改？

    选择网络这一大类，在里面找到连接选项，有多个连接名称，选择INTERNET_B_VID这一项，这个是你互联网的设置，其他是管IPTV的、电话之类的。连接模式改成桥接，把管理页面的各个项都扫一遍，如果有IPv6选项则打开、有DHCP选项则关闭(选择桥接之后应该就没这一项了)、有防火墙就关闭。

  - 光猫的DHCP关了之后无法再通过局域网IP进入光猫管理界面怎么办？

    网上有很多方案，比如SSH连接啥的，但这都很麻烦，我用的是最简单的，0学习的，直接用自己的设备网线直连光猫，然后ipconfig查看光猫的局域网IP，接着用局域网访问即可。

- **路由器开启拨号上网**

  上网方式从自动获取，改为宽带账号上网。宽带账号和密码找你的安装员要，或者打官方电话转人工问他们要。宽带本来就是你自己的，你要你自己的账号密码，他们必须得给。

  完成设置后重启设备，稍待片刻，通过任意设备测试网络、确认连同。

- **开启所有设备的IPv6、放行所有涉及到的网络设备的防火墙**

#### 验证 

完成以上操作后，通过任意设备验证。

- 验证IPv6：

  - 通过任意工具网站在线验证IPv6。
  - 通过命令行或某种方式查询本机IP，通过IP特征确认这个IP是个公共IPv6地址，而非局域网地址。

- 验证端口 & 从外网访问，进行综合验证：

  端口的验证我当时遇到了个坑，当时以为放行了对应防火墙，telnet就能连同，但后来发现，端口如果希望被连通，你的这台机器必须先有服务正在监听这个端口。所以先在本地用nodejs或者spring随便什么东西，起一个简易helloworld网络服务，监听任意端口。

  通过公网IP测试这个端口： 

  - 可以用telnet，
  - 也可以通过浏览器输入网址加端口用http访问，
  - 也可以在网上找那些测试端口连通的在线工具，
  - 用Nmap扫端口。

#### 通过DDNS将NAS映射到固定地址

通过上面的方式只是拿到了公网IP，但这个IP仍然不是静态的，他会根据运营商的某种规则不定时地动态改变。这样一来，在某个未知的时间IP变化，又无从得知这个新地址，导致无法在局域网外访问。并且，IPv6过于复杂的地址，根本无法记忆，输入起来也不方便，不利于使用。所以需要通过DDNS将动态变化的IP地址实时绑定到域名。

DDNS的作用简单来说，就是一个跑在你主机的程序，它会根据设定好的时间，检测本机的IP，如果IP变化，它就会通过你所持有域名的DNS解析服务商提供的API，把新地址报告给域名服务器，这样一来，你购买的域名将始终指向新的、正确的地址。

具体过程为：

- 购买域名→
- 在域名解析中添加一条AAAA记录，地址为你当前的IPv6地址（这部没用也行）→
- 安装适用于你软硬件环境的DDNS-GO版本（直接搜，有很多可用的教程，群晖的话就是那个“我不是矿神”提供的）→
- 进入你DNS供应商的控制台，生成并下载access-key→
- 在DDNS-GO中选择对应的服务商，把key中对应的调用API的密钥填入，填入域名等其他信息，创建并保存配置

遵循和上面一样的验证方法，测试能否通过域名访达。

> 需要注意，群晖似乎本来就不支持在局域网内通过外部网络访问（至少我的是这样，也没找到更改这种规则的配置入口）。所以你在局域网内通过域名或者IPv6去访问管理页面访问不到是正常的，只能拿局域网IP。所以你可以通过手机的移动数据来完成测试。

#### HTTPS

外网访问实现了，网络安全也马虎不得。我是直接用了腾讯云提供的免费ssl证书，可以申请很多张，就是三个月就失效了，要每90天重新配置。

Step1：完成腾讯云一系列的手续之后，创建免费证书，按照提示填入你要加密的域名以及其他信息，按照指引在你的域名解析里添加正确的CNAME记录，完成对域名所属的验证，就可以生成证书了。

（这一步腾讯云自己有文档，网上的图文教程也很多，不展开，其实你按我说的这个去一步步点，猜都猜得出该怎么往下进行）。

Step2：之后根据你部署HTTPS证书的环境，下载对应类型的证书（到底下哪个，你直接去搜你的环境+HTTPS就好了，一堆教程，我我是群晖，下载的nginx的那个。）。

Step3：按照适用于你NAS系统的方式将证书导入。我用的是群晖，位置为：控制面板→连接性-安全性→证书→新增，导入之后，再去设置，把每个服务啥的都选成你自己导入的那张证书。

#### 反向代理：HTTPS只能加密登陆门户or每次带端口都太麻烦？

> 这是一种针对群晖的解决办法，我自己用的是这个，别的我也不了解，但道理是相似的。

配置完HTTPS你会发现，只有门户起作用了，你访问个别的服务，比如照片，文件管理，或者你自己部署的某些服务，浏览器左上角又会提示你不安全，你的HTTPS似乎只对门户的端口生效。

这里我必须要提一句，很多文章对这种现象的分析都是，HTTPS只能用在443端口，这是错误的，HTTPS本身只是一种协议，它只是默认用443，并不是只能443。这就像HTTP默认是80，但你在后面加端口后缀，一样能访问网页一样。

但为什么你用HTTPS前缀做协议，后面加上端口号，依旧不起作用呢？这是因为群晖的默认行为，只会在访问门户的那个端口才应用ssl证书（443我没试过，暂暂不清楚）。

改变这种行为有两个途径：1.配置nginx，这个太麻烦了，要可劲儿的折腾命令行，我懒得弄，感兴趣的可以去搜索。2.反向代理，简单粗暴，我喜欢这个。

而且这能解决另一个问题——每次访问NAS不同服务都要加端口号，太麻烦了。

结论：

1. 在你的域名下创建对应各种服务的子域名，比如photos.wml107.top, web.wml107.top, mcserver.wml107.top，

2. 然后通过群晖的反向代理，把这个域名的HTTPS/443端口访问，映射到localhost对应服务端口的访问，

   > 位置在：控制面板→系统/登陆门户→高级→反向代理服务器/新增

3. 为这些子域名分别生成相应的ssl证书（因为我用的是免费ssl，要给每个子域名单独生成，如果你用的是花钱的大概率没这步），

4. 按照前面配置HTTPS的流程，生成证书、导入证书，最后把你上面为你某个服务创建的那个反向代理，选择刚才导入的那个证书。

   > 位置在：控制面板→连接性/安全性→证书→设置，在这个弹窗的配置列表里，就可以看到你为反向代理添加的新域名了，为它选择与他对应的证书。

至此，你就完成了所有网络环境上的基本工作，能够安全、便捷地，通过域名访问每一项NAS服务了。

#### 内网穿透

除非是你实在懒得研究/学不会以上操作，或者经过这些操作之后发现你家网络上传的端口让运营商封了个干净，除了80、443、8888、8080这些，连那些生僻的都给你封完了，没法通过外网IP实现外网访问。不然真的不建议用内网穿透，真的是又贵又慢、带宽感人。

用的比较多的就是花生壳或者SAKURA FRP吧，去网上搜索推荐，有挺多可选的。

## 系统选择

选择了系统，才能选择硬件，因为某些系统对应的是成品方案，如果是直接买成品，也就不存在什么硬件选择了。

目前有非常多的NAS系统：FreeNAS&NAS4Free、TrueNAS、OpenMediaVault、unRAID、群晖、威联通、极空间、绿联等，

前四个是比较老牌、使用广泛的系统，可以看B站up主钱韦德的这个视频扫个盲：

> 【4大NAS系统介绍（二）：文件存储】 https://www.bilibili.com/video/BV1Ao4y1o7dN/?share_source=copy_web&vd_source=a3f867b43d32c007bbc9e1394816888f

后面那些都是这两年新出的一些品牌成品NAS的系统，这方面，也可以参照这位up主的成品NAS推荐系列视频。

前人已经做过足以供人做出判断的对比了，我自己也没有都买来试一遍，就不拾人牙慧了，主要就是考察功能性、数据迁出难易、备份难易、安全性与稳定性。

我自己得出的结论：这些系统里除了群晖之外，要么是功能不全，连基本的完成度都存在问题；要么就是操作逻辑过于复杂、提供的功能过于强大，上手的学习路线陡峭，我不太愿意花那么大的时间精力折腾。最终我选择了在功能性与易用性之间取得较好平衡的群晖，最后上手的体验也确实印证了这一选择——要用的功能它都有、操作简单、稳定、界面美观。

不过我没有买正版群晖，而是使用了黑群晖——即自己选择硬件组装机器，然后通过网络社区上大佬们提供的一些工具将群晖系统安装到我自己的组装的电脑上，然后把系统洗白，以解锁群晖的全部功能。

主要群晖的这个成品真的是买软件送硬件，强行为对比分出的几个SKU里，低档的几个型号给的实在是太少了，几乎完全不可用，高端的几个版本里，给的硬件也没好到哪去，实在是很不划算，且不够用。让人有心无力，想支持也没法儿。非常期待群晖以后像微软那样，提供单卖的纯系统。

> 说到这个，最近在微博看到小米的官方人员透露小米有做NAS的打算，不知道会不会推出一个好用的纯NAS系统，挺期待。

如果你也想使用黑群晖，这里有几个概念需要你先借助搜索引擎了解：什么是引导；什么是洗半白、洗全白；以及如何洗白。

## 硬件选择   