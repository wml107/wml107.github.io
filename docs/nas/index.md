# NAS

>这里记录我折腾NAS的一些东西、踩过的坑。

> 阅读指南：你需要有最基本的网络、电脑知识，最起码知道NAS大概是做什么的。
>
> 本文只是提供一个整体上的解决方案，像是对资料的整合，也是我自己折腾过程的记录。所以不会事无巨细，隐去的那些细节在网上一搜一大堆，当你操作时卡住了，再去搜索关键词也不迟。

我搭的NAS基本是all in one，如侧边索引所见，除了软路由没做，其他的都差不多了。

**参考：**下面是几个我在折腾的过程中参考过且推荐的网站、博主。

- 【一起玩NAS】https://wiki.slarker.me/
- 【b站up主钱韦德】https://space.bilibili.com/20274090

## 网络环境准备

在一切开始之前，要确保你的网络环境支持访问NAS。

在选择硬件、组装、购买机器之前，先使用一些简单的方法验证的你网络足以使用NAS，别买了机器才发现组了也用不了，那就白买了。

完成这一章的一系列工作，你将：能够安全、便捷地，通过域名访问每一项NAS服务。

### 内网访问

如果你只是在局域网内用，那你几乎什么都不需要做，直接用ipconfig等指令查出局域网IP，拿IP访问即可。

### 外网访问

从外网访问，要做的事情就多了，首先要确保你能有一个公网IP，能在你机器所处的运营商的局域网——例如小区以外，触达你的NAS。

#### 公网IPv6

IPv4基本不可能了，2024年的今天，几乎以个人的力量不可能拿到任何静态IP，联通移动自己也没多少，电信有也不给，我试过很多话术，人家就是不给，人家等着卖企业专线呢。如果你已经能拿到或者你家的网本身就是IPv4，那恭喜你，你可以直接跳过这一步了。

但IPv6就不一样了，这玩意给地球每一粒沙子发，都发不完，运营商没有理由限制，普通人可以轻易获得。

这东西唯一的局限就是，访问者的机器支持IPv6，不过已经24年了，这几年的新设备几乎没有不支持的，但在某些公共场所的网络，他们所提供接入网络的设备或许较老、还不支持。

- **调制解调器拨号改桥接**

  你家的光猫有两种工作模式，一种是路由模式，即现在的猫都集成了路由器的功能，并且默认以这种模式工作，把路由器的活也干了，主要目的是方便运营商控制网络接入，让用户尽可能少的参与网络配置，省的出问题麻烦。【当然，也方便运营商埋点，做数据检测，有没有监控你，那就不得而知了......第二种是桥接模式，这种模式下，调制解调器只完成他的本质工作——光电信号的转换。由路由器来进行拨号、路由/为局域网内设备分配IP。

  这里有一个细节我依旧太明白：按理说光猫承担路由功能，与让路由器自己做相比，这只是改变了我家中局域网接入外部的位置，但本质上他们完成的工作都是一样的。为什么让路由器来拨号，就能把运营商分配给他的IPv6再分配给局域网内的其他设备，而光猫拨号，公网IPv6的分配就到此为止了，光猫就不能也分配吗？我在网上搜索了很多，没得到答案，我推测可能是运营商处于安全或者什么因素的考虑，光猫一开始就被有意设置成这样——以路由模式工作时，只会对内部设备分配静态的内部IPv6地址，不分配外网地址。

  总之就是要将光猫改桥接，让路由器来拨号，这样做还有个好处就是，光猫的硬件性能普遍不怎么样，让他充当路由，性能肯定不如你自己的路由器，能更好的发挥宽带性能。

  需要注意如下几个问题：

  - 如何登陆网关/光猫管理页面？

    按照网关IP进去之后，提示管理页面需要登陆，网上的那些默认账号密码早就过时了，现在的账密都是动态生成的，通过他们运营商的终端输入猫的mac地址，动态生成的。这个东西你直接问给你装宽带的人要，或者打客服，问官方要。他们不给也没关系，一堆运营商的员工那这东西搞副业，去咸鱼搜，关键词为省名+运营商+管理员账号，把mac地址发给他们，几块钱就能给你生成一个。

  - 进光猫管理页面要怎么改？

    选择网络这一大类，在里面找到连接选项，有多个连接名称，选择INTERNET_B_VID这一项，这个是你互联网的设置，其他是管IPTV的、电话之类的。连接模式改成桥接，把管理页面的各个项都扫一遍，如果有IPv6选项则打开、有DHCP选项则关闭(选择桥接之后应该就没这一项了)、有防火墙就关闭。

  - 光猫的DHCP关了之后无法再通过局域网IP进入光猫管理界面怎么办？

    网上有很多方案，比如SSH连接啥的，但这都很麻烦，我用的是最简单的，0学习的，直接用自己的设备网线直连光猫，然后ipconfig查看光猫的局域网IP，接着用局域网访问即可。

- **路由器开启拨号上网**

  上网方式从自动获取，改为宽带账号上网。宽带账号和密码找你的安装员要，或者打官方电话转人工问他们要。宽带本来就是你自己的，你要你自己的账号密码，他们必须得给。

  完成设置后重启设备，稍待片刻，通过任意设备测试网络、确认连同。

- **开启所有设备的IPv6、放行所有涉及到的网络设备的防火墙**

#### 验证 

完成以上操作后，通过任意设备验证。

- 验证IPv6：

  - 通过任意工具网站在线验证IPv6。
  - 通过命令行或某种方式查询本机IP，通过IP特征确认这个IP是个公共IPv6地址，而非局域网地址。

- 验证端口 & 从外网访问，进行综合验证：

  端口的验证我当时遇到了个坑，当时以为放行了对应防火墙，telnet就能连同，但后来发现，端口如果希望被连通，你的这台机器必须先有服务正在监听这个端口。所以先在本地用nodejs或者spring随便什么东西，起一个简易helloworld网络服务，监听任意端口。

  通过公网IP测试这个端口： 

  - 可以用telnet，
  - 也可以通过浏览器输入网址加端口用http访问，
  - 也可以在网上找那些测试端口连通的在线工具，
  - 用Nmap扫端口。

#### 通过DDNS将NAS映射到固定地址

通过上面的方式只是拿到了公网IP，但这个IP仍然不是静态的，他会根据运营商的某种规则不定时地动态改变。这样一来，在某个未知的时间IP变化，又无从得知这个新地址，导致无法在局域网外访问。并且，IPv6过于复杂的地址，根本无法记忆，输入起来也不方便，不利于使用。所以需要通过DDNS将动态变化的IP地址实时绑定到域名。

DDNS的作用简单来说，就是一个跑在你主机的程序，它会根据设定好的时间，检测本机的IP，如果IP变化，它就会通过你所持有域名的DNS解析服务商提供的API，把新地址报告给域名服务器，这样一来，你购买的域名将始终指向新的、正确的地址。

具体过程为：

- 购买域名→
- 在域名解析中添加一条AAAA记录，地址为你当前的IPv6地址（这部没用也行）→
- 安装适用于你软硬件环境的DDNS-GO版本（直接搜，有很多可用的教程，群晖的话就是那个“我不是矿神”提供的）→
- 进入你DNS供应商的控制台，生成并下载access-key→
- 在DDNS-GO中选择对应的服务商，把key中对应的调用API的密钥填入，填入域名等其他信息，创建并保存配置

遵循和上面一样的验证方法，测试能否通过域名访达。

> 需要注意，群晖似乎本来就不支持在局域网内通过外部网络访问（至少我的是这样，也没找到更改这种规则的配置入口）。所以你在局域网内通过域名或者IPv6去访问管理页面访问不到是正常的，只能拿局域网IP。所以你可以通过手机的移动数据来完成测试。

#### HTTPS

外网访问实现了，网络安全也马虎不得。我是直接用了腾讯云提供的免费ssl证书，可以申请很多张，就是三个月就失效了，要每90天重新配置。

Step1：完成腾讯云一系列的手续之后，创建免费证书，按照提示填入你要加密的域名以及其他信息，按照指引在你的域名解析里添加正确的CNAME记录，完成对域名所属的验证，就可以生成证书了。

（这一步腾讯云自己有文档，网上的图文教程也很多，不展开，其实你按我说的这个去一步步点，猜都猜得出该怎么往下进行）。

Step2：之后根据你部署HTTPS证书的环境，下载对应类型的证书（到底下哪个，你直接去搜你的环境+HTTPS就好了，一堆教程，我我是群晖，下载的nginx的那个。）。

Step3：按照适用于你NAS系统的方式将证书导入。我用的是群晖，位置为：控制面板→连接性-安全性→证书→新增，导入之后，再去设置，把每个服务啥的都选成你自己导入的那张证书。

#### 反向代理：HTTPS只能加密登陆门户or每次带端口都太麻烦？

> 这是一种针对群晖的解决办法，我自己用的是这个，别的我也不了解，但道理是相似的。

配置完HTTPS你会发现，只有门户起作用了，你访问个别的服务，比如照片，文件管理，或者你自己部署的某些服务，浏览器左上角又会提示你不安全，你的HTTPS似乎只对门户的端口生效。

这里我必须要提一句，很多文章对这种现象的分析都是，HTTPS只能用在443端口，这是错误的，HTTPS本身只是一种协议，它只是默认用443，并不是只能443。这就像HTTP默认是80，但你在后面加端口后缀，一样能访问网页一样。

但为什么你用HTTPS前缀做协议，后面加上端口号，依旧不起作用呢？这是因为群晖的默认行为，只会在访问门户的那个端口才应用ssl证书（443我没试过，暂暂不清楚）。

改变这种行为有两个途径：1.配置nginx，这个太麻烦了，要可劲儿的折腾命令行，我懒得弄，感兴趣的可以去搜索。2.反向代理，简单粗暴，我喜欢这个。

而且这能解决另一个问题——每次访问NAS不同服务都要加端口号，太麻烦了。

结论：

1. 在你的域名下创建对应各种服务的子域名，比如photos.wml107.top, web.wml107.top, mcserver.wml107.top，

2. 然后通过群晖的反向代理，把这个域名的HTTPS/443端口访问，映射到localhost对应服务端口的访问，

   > 位置在：控制面板→系统/登陆门户→高级→反向代理服务器/新增

3. 为这些子域名分别生成相应的ssl证书（因为我用的是免费ssl，要给每个子域名单独生成，如果你用的是花钱的大概率没这步），

4. 按照前面配置HTTPS的流程，生成证书、导入证书，最后把你上面为你某个服务创建的那个反向代理，选择刚才导入的那个证书。

   > 位置在：控制面板→连接性/安全性→证书→设置，在这个弹窗的配置列表里，就可以看到你为反向代理添加的新域名了，为它选择与他对应的证书。

至此，你就完成了所有网络环境上的基本工作，能够安全、便捷地，通过域名访问每一项NAS服务了。

#### 内网穿透

除非是你实在懒得研究/学不会以上操作，或者经过这些操作之后发现你家网络上传的端口让运营商封了个干净，除了80、443、8888、8080这些，连那些生僻的都给你封完了，没法通过外网IP实现外网访问。不然真的不建议用内网穿透，真的是又贵又慢、带宽感人。

用的比较多的就是花生壳或者SAKURA FRP吧，去网上搜索推荐，有挺多可选的。

## 系统选择

选择了系统，才能选择硬件，因为某些系统对应的是成品方案，如果是直接买成品，也就不存在什么硬件选择了。

目前有非常多的NAS系统：FreeNAS&NAS4Free、TrueNAS、OpenMediaVault、unRAID、群晖、威联通、极空间、绿联等，

前四个是比较老牌、使用广泛的系统，可以看B站up主钱韦德的这个视频扫个盲：

> 【4大NAS系统介绍（二）：文件存储】 https://www.bilibili.com/video/BV1Ao4y1o7dN/?share_source=copy_web&vd_source=a3f867b43d32c007bbc9e1394816888f

后面那些都是这两年新出的一些品牌成品NAS的系统，这方面，也可以参照这位up主的成品NAS推荐系列视频。

前人已经做过足以供人做出判断的对比了，我自己也没有都买来试一遍，就不拾人牙慧了，主要就是考察功能性、数据迁出难易、备份难易、安全性与稳定性。

我自己得出的结论：这些系统里除了群晖之外，要么是功能不全，连基本的完成度都存在问题；要么就是操作逻辑过于复杂、提供的功能过于强大，上手的学习路线陡峭，我不太愿意花那么大的时间精力折腾。最终我选择了在功能性与易用性之间取得较好平衡的群晖，最后上手的体验也确实印证了这一选择——要用的功能它都有、操作简单、稳定、界面美观。

不过我没有买正版群晖，而是使用了黑群晖——即自己选择硬件组装机器，然后通过网络社区上大佬们提供的一些工具将群晖系统安装到我自己的组装的电脑上，然后把系统洗白，以解锁群晖的全部功能。

主要群晖的这个成品真的是买软件送硬件，强行为对比分出的几个SKU里，低档的几个型号给的实在是太少了，几乎完全不可用，高端的几个版本里，给的硬件也没好到哪去，实在是很不划算，且不够用。让人有心无力，想支持也没法儿。非常期待群晖以后像微软那样，提供单卖的纯系统。

> 说到这个，最近在微博看到小米的官方人员透露小米有做NAS的打算，不知道会不会推出一个好用的纯NAS系统，挺期待。

如果你也想使用黑群晖，这里有几个概念需要你先借助搜索引擎了解：什么是引导；什么是洗半白、洗全白；以及如何洗白。

## 硬件选择   

主要的硬件就是下面这四个，其他的东西，要么是能亮就行，要么则是某个特定的玩法、NAS功能涉及到时再单独提及。

### CPU

因为用的是黑群晖，群晖的各个版本系统，都是针对某些特定硬件的，所以装黑群晖，就要让硬件与你选系统对应的白裙晖成品里的硬件接近，来避免出现兼容性问题。在所有硬件里，最要紧的就是CPU，对不上的话会导致系统装了用不了。

到底要选择哪个系统，系统对应的硬件支持情况，推荐看这篇文章，写的简洁明了，各位可以根据自己的需要选择：

> https://nga.178.com/read.php?tid=38650456&rand=91

我的系统装的是DS918，最终CPU选了8100，其实是选择有点老。我主要是基于这几点考虑的：群晖的机器用的硬件普遍都比较老旧，即便是2024年的今天，黑裙已经能支持11代以上的CPU了，我仍然不敢选，怕出现什么兼容性上的小毛病，毕竟目前用的人还太少了，我自己的不太愿意去主动排查解决问题，用一个市场保有较多的版本，出了问题也要找解决方案，所以最终还是把目光落在了Intel8代上面。

确定了CPU系列之后，看了一些评测，觉得八代的奔腾赛扬，硬解性能不行。太好的CPU功耗太高，NAS也用不到。折衷一下，就选了8100。至于8100和8100T的区别，你完全无须纠结，标称确实是带T的功耗低一些，但实测他俩待机功耗基本上一摸一样，完全不用为了那点功耗多花钱还牺牲性能，选8100就完事儿了。

> 其实事后证明，完全多虑了，因为我当时根本就不清楚什么是硬解，所以这里也必须向读文章的你提一嘴，省的去追求一些用不着的需求：
>
> 视频硬解在绝大时候是用不到的，并且他不是提升画质的，是用来降低画质的。
>
> 具体讲就是，如果你在家中的局域网，用各种终端播放时NAS上的视频，你那些终端上的硬件与播放器都具备解码功能，不是由NAS来完成解码的;
>
> 只有你在外网访问NAS中视频的时候，因为家庭宽带的带宽太低，只有30-50M，需要把你的那些电影啥的降画质传输，以免卡顿，这才需要你NAS的CPU的硬解功能完成视频质量的转换。

### 主板

主板不存在什么对群晖系统的兼容性，保证能兼容你CPU、塞进机箱这两个最基本的之后，主要的考虑都集中在扩展性：

- 内存扩展性，几个插槽、最大容量。
- PCIe扩展性，给了几条、通道数都是多少、什么版本的、支不支持PCIe拆分。
- M2，又几个M.2插槽，在什么位置、什么尺寸、支持的速度。
- SATA接口个数。
- 背部I/O数量。
- 网卡，网卡数目、带宽、品牌型号（这个要在网上搜搜，有的型号和群晖配合的不太好，有的型号本身不太靠谱）
- 方便NAS的各种特色功能：
  - 来电自启
  - 唤醒时间与自动关机
  - 网络远程唤醒
  - RAID支持情况
  - 插在机箱内部主板上的直插式USB
  - ......

这时候，选8代CPU的麻烦就凸显了，这东西太老了，新主板没有，咸鱼的话，这两年NAS这个小众爱好太🔥了，8100这颗U也太热门了，导致稍微各方面说的过去的主板，其实各方面也就那样，但价格却很贵；便宜点的，要么就是扩展性奇差丐中丐，要么就是成色极差，很难怀疑回来能稳定用不能；再加上我现有准备用的机箱是ITX的，我还主打的是一个捡垃圾，走性价比路线，主板就更难买了。

按照上面的标准筛一波，几乎没啥可用的，如果你不追求CPU性能，妖板厂商华擎的j3455、j4105，都是可以考虑的，市场保有量很高，咸鱼一搜一大堆，非常便宜，都是全新/成色很好。这东西是那种CPU集成在主板上的，还省的你买CPU、硅脂、散热器了(被动式散热)，要是你用不着硬解，也没有拿NAS做游戏服务器的打算，够用了。

因为我当时的需求是要上8100，最终找到了一家很神奇的淘宝店：深圳雲星。这个雲星主板是专门做NAS的，所以主板提供的很多东西，非常切中痛点，然后这个牌子的产品也做了一段时间了，我看买他的NAS玩家挺多的，没发现有什么问题，挺稳的。

最后选的是雲星ITX- CS2，

- ITX版型，
- B250芯片组，支持6～9代Intel处理器，不需要你自己刷BIOS，
- 6个原生SATA3.0、2个PCIe3.0 X4，长度支持到22110的M.2、1个PCIe3.0 X16支持拆分，
- 双RTL8125B 2.5G网卡，
- I/O方面，2个USB3.0、2个USB2.0、HDMI1.4、DP1.2、音频接口，除此之外内置接口还提供了USB3.0、USB2.0排针，和一个主板内部直插USB2.0
- BIOS方面，我上面提到的那些方便NAS使用的小功能都有

考虑到支持着么多东西，花450就450吧。

### 内存

内存这块，不是打游戏，对于服务器的工作，频率意义不大，然后8100和那张主板支持的频率、DDR4本来的频率都不高，频率这块就无所谓了，2133、2400、2666都行。

容量肯定是越大越好，但存在一个问题就是，群晖的系统能识别到吗？因为群晖的系统都是针对于特定型号硬件的，就怕人家做系统的时候，某些原始设定就是内存不大于多少，然后系统永远不会去超出这个容量的内存位置去寻址。

DS918这个系统对应的成品官网描述最大只能加到8G，然后我看网上有人装这个版本系统加到32也能用，更多就不得而知了。

但我目前没遇到什么吃内存容量的场景，已知的三种情形：游戏服务器，比如帕鲁这种，很吃内存；你以后可能在你NAS上跑的某个Web服务；使用Unraid 或者 TrueNAS作为系统时，用ZFS这个文件系统组RAID，ZFS 会使用内存来作为缓存，比较吃内存。一般而言，8G就够了。

### 硬盘

#### 固态还是机械？

群晖系统不支持NVMe固态用于存储，只能用作缓存，因为目前还没有任何一台正版群晖的成品机拿这个当存储盘。你买来只能拿他当缓存盘，加速读写。<br>我就买了一根Intel的16g傲腾，才十几块钱，很好玩。然后如果你也想买这个作缓存，还有一点需要注意，群晖系统只有插入两根NVMe固态，才能用于同时加速读写，单插一根只能用作读缓存，不能用于写。不过我刚好没这个需求，不打算加速写：写的话，如果是小文件，感知不明，如果是大文件，除非你容量买的够大，不然写一会就出缓了，速度像过山车，绝大多数时间都出缓了。只用来做读缓存，加速平常那些小文件访问，优化4k性能，挺不错的。

SATA固态依旧不是一个好选择，因为NVMe出来太久了，市面上现在几乎已经没有什么SATA产品了，你去收寿命未知的二手SATA来组NAS显然也不是一个好选择。这些产品性能极其落后，几乎就是大号U盘，像凯侠、闪迪、英睿达的那些产品，没了当年SATA时代的mlc颗粒，但现在主流tlc产品上的固件调教、读写策略、缓存策略这些大概率在这种小众产品上也不存在，寿命和性能都不容乐观，价格又出奇的贵。咸鱼的二手SATA大概率都是清零盘、翻新盘，盘里的闪存颗粒大概率是卖家不知道从哪儿弄来焊上去的。

其实用机械也没什么不好的，相比于上面那些东西给你可能带来的提升，影响速度的瓶颈其实可能在你的网卡带宽和你家宽带的速度【我家的千兆实际多数时间测只有六百多)。

#### 要不要组RAID？

没必要，RAID就是两方面，一个是加速读写，这个东西能提供的速度提升，实在是很小，没什么实际收益，要是愿意折腾这个，还不如去研究操作下，通过命令行变更默认行为，将NVMe固态作为存储盘。

二呢是提升系统可靠性，注意这里说的是可靠性，而不是备份。这是一个很大的误区，很多地方都说RAID是用来备份的，但事实上由于物理破坏导致冗余盘都挂了的概率还挺大的。为什么说他是用来提高可靠性，而不是用来备份的呢，是因为RAID的目的，是为了在系统运行中某一块盘坏掉的时候，另一块盘能立刻顶上，让服务快速恢复。说白了这个东西的用途是用来提用7*24服务的，你一个个人用途的NAS，要24小时不间断服务干嘛呢？挂了就挂了呗。实际上你NAS硬盘在他运行过程中出问题的概率，比你某天不小心把水撒上面，或者搬运过程中由于震动导致所有硬盘都损坏的概率，小多了。

#### 机械怎么选？

除了不必提的那些基本参数，还需要了解下磁记录方式，区分CMR和SMR，避雷叠瓦盘。具体请看下面科普：

> 【选购机械硬盘的大坑，不看你就上当，详解SMR瓦楞式堆叠硬盘】 https://www.bilibili.com/video/BV1rE411Q71m/?share_source=copy_web&vd_source=a3f867b43d32c007bbc9e1394816888f

具体选购推荐看看b站up钱韦德的视频合集：机械硬盘选购和避坑

>https://space.bilibili.com/20274090/channel/collectiondetail?sid=208558
>
>最新的选购视频：【2024年618机械硬盘选购指南】 https://www.bilibili.com/video/BV1NE421F7bR/?share_source=copy_web&vd_source=a3f867b43d32c007bbc9e1394816888f

机械硬盘的命名规则杂乱无章，型号名又长又乱，不易区分。选择时注意翻一翻商品详情，找到商家标注的型号比对一下；<br>且时效性很强，很可能当你看到这里时，视频里提到的型号都不存在了。选购的时候还是要多对比，找找有没有更便宜的同方案型号。

#### 使用NVMe固态作为缓存盘时，无法被群晖识别？

群晖系统提前设置了各个机型NVMe硬盘在机器中的PCI位置，然后直接写死进了操作系统，所以你自己主板上插盘的位置和你这个系统对应成品机器的位置不一样，就识别不了。把这个系统文件找出来，改一下这个位置之后，就能识别到了。

具体操作可参考：

> 【群晖918+ DSM7.X系统开启并使用NVME（M2）硬盘做缓存或存储硬盘教程】https://xywnas.com/?p=2567

#### 在群晖上使用NVMe固态作存储盘

上面说不支持，只是群晖默认将NVMe固态视作缓存盘，在解决固态的识别问题后，进行一系列修改，NVMe固态也是能用于创建存储池的。具体操作上面那个链接里也有，不过我还没试过。

## 相册



## 影音中心



## 文件管理/私有云



## 权限控制



## 备份&迁出



## 游戏服务器



## Web应用服务器



## 下载



## 套件中心与Docker

